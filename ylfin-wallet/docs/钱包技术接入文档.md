# 钱包技术接入文档

## 概念解读

![账户体系](media/15160074516517/%E8%B4%A6%E6%88%B7%E4%BD%93%E7%B3%BB.jpg)


### 虚拟账户

钱包用户/收单用户在银行开设的虚拟账户, 用户要使用钱包功能, 必须开设虚拟账户并绑定银行卡

### 充值

用户将银行卡上的钱转入到该用户自己的虚拟账户余额中(类似钱存到支付宝余额)

### 提现

用户将自己虚拟账户中的钱转出到自己的银行卡上(类似支付宝余额提现)

### 划账

用户虚拟账户之间的资金划拨(类似使用支付宝余额消费)

## 钱包 Oauth 授权接口

### 绑定开户

![Oauth 授权](media/15160074516517/Oauth%20%E6%8E%88%E6%9D%83.jpg)

## 钱包在线支付接口

![在线支付](media/15160074516517/%E5%9C%A8%E7%BA%BF%E6%94%AF%E4%BB%98.jpg)


### 钱包下单服务接口

#### 通用说明

非特殊说明下 

1. 商户向钱包发起请求的报文载体统一为 x-www-form-urlencoded 格式;
2. 钱包同步响应结果为 json 格式, 钱包异步通知报文载体统一为 x-www-form-urlencoded 格式;
3. 钱包响应 http status = 200 时, 代表业务请求响应成功, 需要验证返回结果签名;
4. 钱包响应 http status != 200, 代表业务请求响应失败, 不需要验证返回结果签名;

#### 请求参数

| 参数 | 类型  | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| appId | string | Y | 钱包分配给接入应用的 appId 标识 |
| outTradeNo | string | Y | 标识商户应用下唯一交易流水号, 不可重复提交 |
| subject | string | Y | 订单标题 |
| content | string | N | 订单信息 |
| amount | decimal(10,2) | Y | 订单金额(单位为元) |
| validMins | int | N | 订单未支付超时关闭时间(默认1440分钟) |
| returnUrl | string | N | 支付成功后跳转的 url, GET 方式 |
| notifyUrl | string | N | 支付成功后接收异步通知的 url, POST 方式 |
| cancelUrl | string | N | 用户取消支付时返回的 url, GET 方式 |
| signType | string | Y | 签名方式, 目前只支持 RSA 方式签名 |
| sign | string | Y | RSA签名, 签名算法参见签名说明 |

#### 返回参数

| 参数 | 类型  | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| appId | string | Y | 钱包分配给接入应用的 appId 标识 |
| outTradeNo | string | Y | 标识商户应用下唯一交易流水号, 不可重复提交 |
| payOrderNo | string | Y | 钱包订单唯一流水号 |
| orderTime | string | Y | 下单时间 |
| amount | decimal(10,2) | Y | 订单金额(单位为元) |
| validMins | int | N | 订单未支付超时关闭时间(默认1440分钟) |
| payUrl | string | Y | 支付跳转 url |
| signType | string | Y | 签名方式, 目前只支持 RSA 方式签名 |
| sign | string | Y | RSA签名, 签名算法参见签名说明 |
| errorCode | string | N | 错误信息代码,(只有在 http status 非 200 时会出现) |
| message | string | N | 错误信息描述,(只有在 http status 非 200 时会出现) |

##### 返回示例

> 成功返回

> ```json
{
  "data": {
    "appId": "xxx",
    "outTradeNo": "20180115181337",
    "payOrderNo": "201801151813370000001",
    "orderTime": "20180115181337",
    "amount": 0.01,
    "validMins": 1440,
    "payUrl": "https://wallet.ylfin.com/gateway/payment?payOrderNo=201801151813370000001"
  },
  "signType": "RSA",
  "sign": "yyy"
}
```

> 失败返回

> ```json
{
  "errorCode": "DUPLICATE_OUT_TRADE_NO",
  "message": "订单号重复"
}
```

#### 支付成功通知参数

| 参数 | 类型  | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| appId | string | Y | 钱包分配给接入应用的 appId 标识 |
| outTradeNo | string | Y | 标识商户应用下唯一交易流水号, 不可重复提交 |
| payOrderNo | string | Y | 钱包订单唯一流水号 |
| orderTime | string | Y | 下单时间 |
| amount | decimal(10,2) | Y | 订单金额(单位为元) |
| paymentTime | string | N | 支付时间 |
| orderStatus | string | Y | 订单状态: CLOSED(订单超时关闭), SUCCESS(订单支付成功), UNPAY(等待支付) |
| signType | string | Y | 签名方式, 目前只支持 RSA 方式签名 |
| sign | string | Y | RSA签名, 签名算法参见签名说明 |

### 订单查询接口

#### 请求参数

| 参数 | 类型  | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| appId | string | Y | 钱包分配给接入应用的 appId 标识 |
| outTradeNo | string | Y | 标识商户应用下唯一交易流水号 |
| signType | string | Y | 签名方式, 目前只支持 RSA 方式签名 |
| sign | string | Y | RSA签名, 签名算法参见签名说明 |

#### 返回参数

| 参数 | 类型  | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| appId | string | Y | 钱包分配给接入应用的 appId 标识 |
| outTradeNo | string | Y | 标识商户应用下唯一交易流水号, 不可重复提交 |
| payOrderNo | string | Y | 钱包订单唯一流水号 |
| orderTime | string | Y | 下单时间 |
| amount | decimal(10,2) | Y | 订单金额(单位为元) |
| validMins | int | N | 订单未支付超时关闭时间(默认1440分钟) |
| payUrl | string | Y | 支付跳转 url |
| orderStatus | string | Y | 订单状态: CLOSED(订单超时关闭), SUCCESS(订单支付成功), UNPAY(等待支付) |
| signType | string | Y | 签名方式, 目前只支持 RSA 方式签名 |
| sign | string | Y | RSA签名, 签名算法参见签名说明 |

### 对账单下载

商户只能下载当天之前的对账单文件

#### 请求参数

| 参数 | 类型  | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| appId | string | Y | 钱包分配给接入应用的 appId 标识 |
| txDate | string | Y | 交易日期(yyyyMMdd)|
| txType | int | N | 账单类型, 1-支付订单, 2-退款订单, 默认为1 |
| signType | string | Y | 签名方式, 目前只支持 RSA 方式签名 |
| sign | string | Y | RSA签名, 签名算法参见签名说明 |

#### 返回结果

| 参数 | 类型  | 是否必填 | 说明 |
| :--- | :--- | :--- | :--- |
| downloadUrl | string | Y | 对账单文件下载地址 |

#### 对账单文件格式

待补充

### 签名说明

#### 请求参数签名

1. 筛选
获取所有请求参数(空白参数除外)，不包括字节类型参数，如文件、字节流，剔除sign参数。

2. 排序
将筛选的参数按照第一个字符的键值ASCII码递增排序（字母升序排序），如果遇到相同字符则按照第二个字符的键值ASCII码递增排序，以此类推。

3. 拼接
将排序后的参数与其对应值，组合成“参数=参数值”的格式，并且把这些参数用&字符连接起来，此时生成的字符串为待签名字符串。RSA签名的商户将待签名字符串和商户私钥带入SHA1算法中得出sign。

4. 将得到的字符串使用商户的 RSA 私钥进行加签

#### 同步返回参数验签

将 data 节点中返回的字符串使用 钱包提供的 RSA 公钥进行验签

#### 异步通知参数验签

1. 筛选
获取所有请求参数(空白参数除外)，不包括字节类型参数，如文件、字节流，剔除sign参数。

2. 排序
将筛选的参数按照第一个字符的键值ASCII码递增排序（字母升序排序），如果遇到相同字符则按照第二个字符的键值ASCII码递增排序，以此类推。

3. 拼接
将排序后的参数与其对应值，组合成“参数=参数值”的格式，并且把这些参数用&字符连接起来，此时生成的字符串为待签名字符串。RSA签名的商户将待签名字符串和商户私钥带入SHA1算法中得出sign。

4. 将得到的字符串使用 钱包提供的 RSA 公钥进行验签

